<!doctype html>
<html lang="zh-CN" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>时间显示器</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* --------------------------------- 替换后的 CSS 样式 (基于 A2 V2 风格) --------------------------------- */
    
    body {
      box-sizing: border-box;
      overflow: hidden;
      font-family: 'PingFang SC', 'Microsoft YaHei', 'Helvetica Neue', sans-serif;
      /* 采用 A2 的深蓝背景 */
      background: linear-gradient(135deg, #0a1a3a 0%, #0d2b5c 50%, #0f2e65 100%);
    }
    
    /* 辉光效果动画 - A2保留 */
    @keyframes gentleGlow {
      0%, 100% { filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.3)); }
      50% { filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.5)); }
    }
    
    @keyframes subtlePulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    
    /* 雪花动画 - A2保留 */
    @keyframes snowFall {
      0% { transform: translateY(-10px) translateX(0); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(calc(100vh + 20px)) translateX(20px); opacity: 0; }
    }
    
    /* 雨滴动画 - A2保留 */
    @keyframes rainFall {
      0% { transform: translateY(-10px) translateX(0); opacity: 0; }
      10% { opacity: 0.7; }
      90% { opacity: 0.7; }
      100% { transform: translateY(calc(100vh + 20px)) translateX(10px); opacity: 0; }
    }
    
    .fade-in { animation: fadeIn 0.8s ease-out; }
    .colon-blink { animation: pulse 2s ease-in-out infinite; }
    .gentle-glow { animation: gentleGlow 3s ease-in-out infinite; }
    .subtle-pulse { animation: subtlePulse 4s ease-in-out infinite; }
    
    .time-display {
      font-variant-numeric: tabular-nums;
      letter-spacing: -0.02em;
    }
    
    /* --------------------------------- 玻璃效果卡片 - 采用 A2 V2 风格 --------------------------------- */

    /* A1 版的 V1/V2 布局卡片（统一 V2 风格）*/
    .glass-card-v1, .glass-card-v2-main { /* V2 布局主卡片 */
        background: linear-gradient(135deg, 
            rgba(255, 255, 255, 0.05) 0%, 
            rgba(255, 255, 255, 0.02) 100%);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 1.5rem; /* V1 和 V2 布局卡片圆角 */
    }

    /* ********************************************** */
    /* *** 核心修改 1: 设置面板样式和回弹动画 (定稿丝滑效果) *** */
    /* ********************************************** */
    
    #config-panel-unified {
        /* 优化后的深蓝透明玻璃背景，加深颜色，减少黑感 */
        background: rgba(8, 25, 50, 0.9); /* 更深的蓝色，接近 #081932 */
        backdrop-filter: blur(20px); 
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.15); 
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6); /* 更强的阴影 */
        border-radius: 2.5rem; 
        
        /* 核心优化：定稿的回弹动画参数 (0.6s / cubic-bezier(0.3, 1.3, 0.5, 1.2)) */
        transition: transform 0.6s cubic-bezier(0.3, 1.3, 0.5, 1.2), opacity 0.4s ease-out;
        /* Z-index 保持不变，由 JS 控制，这里设置为默认值 */
        z-index: 50; 
    }

    /* 设置面板关闭时的初始状态 (隐藏由JS控制) */
    .config-hidden {
        transform: translate(-50%, -50%) scale(0.95); /* 稍微大一点的起始比例 */
        opacity: 0;
    }
    
    /* 设置面板打开时的回弹效果 */
    .config-active {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }
    
    /* 通用按钮回弹效果 (保持不变) */
    .btn-spring-effect {
        transition: transform 0.15s cubic-bezier(0.2, 0.9, 0.3, 1.35); 
    }
    .btn-spring-effect:active {
        transform: scale(0.95);
    }
    
    /* 粒子基础样式 - A2保留 */
    .weather-particle { position: absolute; pointer-events: none; z-index: 100; }
    .snowflake { 
      background: rgba(255, 255, 255, 0.9); 
      border-radius: 50%; 
      /* 核心修改 3: 雪景辉光增强 (从 0.5 增强到 0.8) */
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.8); 
    }
    .raindrop {
      background: linear-gradient(to bottom, rgba(173, 216, 230, 0.8) 0%, rgba(135, 206, 250, 0.8) 100%);
      border-radius: 50% 50% 50% 0;
      transform: rotate(135deg);
      box-shadow: 0 0 8px rgba(135, 206, 250, 0.6);
    }
    
    /* 文本辉光效果 - A2保留 */
    .text-glow-white { 
      text-shadow: 0 0 20px rgba(255, 255, 255, 0.6), 0 0 40px rgba(255, 255, 255, 0.3); 
    }
    .text-glow-blue { 
      text-shadow: 0 0 15px rgba(100, 200, 255, 0.6), 0 0 30px rgba(100, 200, 255, 0.3); 
    }
    .text-glow-light { 
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.4), 0 0 20px rgba(255, 255, 255, 0.2); 
    }
    
    /* V2 特有的辉光样式 (A2保留) */
    .glowing { 
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 25px rgba(255, 255, 255, 0.5), 0 0 40px rgba(100, 180, 255, 0.4); 
    }
    .blue-glow-text { 
      text-shadow: 0 0 8px rgba(96, 165, 250, 0.6); 
      color: #7dd3fc; 
    }
    .title-glow { 
      /* 核心修改 4: 标题辉光增强 (从 0.7 增强到 0.8，从 0.4 增强到 0.5) */
      text-shadow: 0 0 15px rgba(255, 255, 255, 0.8), 0 0 30px rgba(100, 180, 255, 0.5); 
    }

    /* 核心优化：V2 布局中 time/timezone 的单行显示 */
    #time-timezone-wrapper-v2 {
        white-space: nowrap; /* 强制单行 */
        overflow: hidden;
    }
    
    /* 隐藏类 */
    .hidden { display: none; }

    /* --------------------------------- 全屏遮罩样式 (A1保留) --------------------------------- */
    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6); 
      backdrop-filter: blur(8px); 
      -webkit-backdrop-filter: blur(8px);
      z-index: 40; 
      transition: opacity 0.3s ease;
      opacity: 0;
      pointer-events: none; 
    }

    #overlay.active {
      opacity: 1;
      pointer-events: auto; 
    }

    /* --------------------------------- 配置面板 UI --------------------------------- */
    
    /* ********************************************** */
    /* *** 核心修改 2: 时区显示框/按钮的单行省略号样式 (定稿) *** */
    /* ********************************************** */

    .custom-timezone-display {
        background-color: #1a2c53; /* 深蓝色块 */
        border: 1px solid transparent; 
        border-radius: 0.75rem; 
        cursor: pointer;
        transition: background-color 0.2s;
        /* 强制父容器单行 */
        white-space: nowrap; 
        overflow: hidden;
    }
    .custom-timezone-display:hover {
        background-color: #1e3a8a;
    }

    /* 针对内部的文本 span 应用溢出省略号 */
    #current-timezone-name {
        /* 确保文本在 flex 布局中可以被截断 */
        min-width: 0; 
        overflow: hidden;
        text-overflow: ellipsis; 
    }
    
    /* 模拟箭头（圆滑） */
    .select-arrow {
        pointer-events: none; 
        color: #7dd3fc; 
        font-size: 0.875rem; 
        /* 确保箭头不会被省略号截断，并保持最小间距 */
        flex-shrink: 0; 
        margin-left: 0.5rem;
    }
    
    /* 时区状态显示样式 (保持不变) */
    .timezone-status-display {
        background-color: #1e3a8a; 
        color: #93c5fd; 
        border-radius: 0.75rem;
        padding: 0.5rem 0.75rem;
        text-align: center;
        font-size: 0.875rem; 
        font-weight: 500; 
        pointer-events: none; 
        user-select: none;
        transition: opacity 0.3s ease;
    }
    
    /* 其他配置按钮的样式保持不变 */
    .config-button-base { 
        border-radius: 0.75rem; 
        border: 2px solid transparent; 
        transition: background-color 0.2s ease;
    }

    .config-button-active {
        background-color: #3b82f6; 
        border-color: transparent; 
    }

    .config-button-inactive {
        background-color: #1a2c53; 
        border-color: transparent;
    }

    .config-button-inactive:hover {
        background-color: #1e3a8a; 
    }

    /* 重新定义滑动条的样式，使其匹配纯色块主题 */
    #weather-speed-unified {
      height: 8px;
      background: #1a2c53; 
    }

    /* 保存按钮改为蓝色 */
    .save-button-blue {
        background-color: #3b82f6;
        background-image: linear-gradient(to right, #3b82f6, #2563eb);
        border: 2px solid transparent; 
    }
    .save-button-blue:hover {
        background-color: #2563eb;
        background-image: linear-gradient(to right, #2563eb, #1d4ed8);
    }
    
    /* --------------------------------- 自定义时区选择模态弹窗样式 --------------------------------- */
    
    #modal-overlay {
      /* 用于遮盖配置面板，只在时区选择和开发者/高级定义时激活 */
      position: fixed;
      inset: 0;
      /* 核心修复：增强遮罩颜色和模糊效果 */
      background: rgba(8, 25, 50, 0.3); 
      backdrop-filter: blur(10px); 
      -webkit-backdrop-filter: blur(10px);
      z-index: 55; 
      opacity: 0; 
      transition: opacity 0.3s ease;
      pointer-events: none; /* 默认不可点击 */
    }
    
    #modal-overlay.active {
        opacity: 1;
        pointer-events: auto;
    }

    #timezone-modal, #dev-mode-modal, #advanced-config-modal { /* 沿用时区模态框的样式，新增高级配置 */
        background: rgba(8, 25, 50, 0.95); /* 比主面板更深的背景 */
        backdrop-filter: blur(25px); 
        -webkit-backdrop-filter: blur(25px);
        border: 1px solid rgba(255, 255, 255, 0.2); 
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
        border-radius: 2rem; /* 大圆角 */
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        z-index: 60; /* 默认在配置面板之上 */
    }

    /* 核心修改 3: 模态弹窗选项 (定稿：保持原样，移除单行省略号强制) */
    .timezone-option {
        background-color: #1a2c53; 
        border-radius: 0.75rem;
        transition: background-color 0.2s, transform 0.1s;
        /* 允许自动换行，保持原始显示效果 */
    }
    .timezone-option:hover {
        background-color: #1e3a8a;
    }
    .timezone-option.active-option {
        background-color: #3b82f6; 
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
    }
    
    /* 自定义开发者模式输入框样式 */
    .dev-input {
        width: 100%;
        padding: 0.75rem 1rem;
        background-color: #1a2c53;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.75rem;
        color: white;
        font-size: 1rem;
        transition: border-color 0.2s;
    }
    .dev-input:focus {
        outline: none;
        border-color: #3b82f6;
    }
    
    /* ********************************************** */
    /* *** 核心修改 1: 开发者输入框的占位符半透明样式 (M2 新增) *** */
    /* ********************************************** */
    .dev-input::placeholder {
        color: rgba(255, 255, 255, 0.5); /* 50% 透明度的白色 */
        opacity: 1; /* 确保在 Firefox 中颜色设置生效 */
    }
    .dev-input::-webkit-input-placeholder { /* Webkit/Blink */
        color: rgba(255, 255, 255, 0.5);
    }
    .dev-input::-moz-placeholder { /* Firefox */
        color: rgba(255, 255, 255, 0.5);
        opacity: 1;
    }
    .dev-input:-ms-input-placeholder { /* IE/Edge */
        color: rgba(255, 255, 255, 0.5);
    }
    /* ---------------------------------------------------- */
    
    /* ********************************************** */
    /* *** 新增：居中主题设置面板标题的样式 *** */
    /* ********************************************** */
    .theme-title-center {
        justify-content: center !important; /* 强制 flex 布局居中 */
    }

  </style>
 </head>
 <body class="h-full deep-blue-bg">
  
  <div id="weather-container" class="absolute inset-0 overflow-hidden z-0"></div>

  <div id="overlay" class="hidden"></div>
  
  <div id="modal-overlay" class="hidden"></div>


  <div id="layout-v1" class="w-full h-full overflow-auto flex items-center justify-center p-4">
    <div class="glass-card-v1 p-8 max-w-md w-full fade-in relative z-10">
      <div class="mb-8">
        <div class="text-center mb-6">
          <h2 id="custom-title-cn-v1" class="text-2xl font-medium text-white gentle-glow mb-1">今天过得怎么样？</h2>
          <p id="custom-title-en-v1" class="text-base opacity-80 text-blue-200">How was your day?</p>
        </div>
        
        <div class="text-center mb-2">
          <h1 id="title-v1" class="text-4xl font-bold text-white text-glow-white mb-1">Sky</h1>
          <p id="city-name-v1" class="text-lg opacity-90 text-blue-300">定位中 城市</p> 
        </div>
      </div>
      
      <div class="text-center mb-8">
       <div class="time-display flex justify-center items-center gap-1 mb-2">
        <span id="hours-v1" class="text-7xl font-bold text-white text-glow-white">04</span>
        <span class="colon-blink text-7xl font-bold text-white">:</span>
        <span id="minutes-v1" class="text-7xl font-bold text-white text-glow-white">14</span>
       </div>
       
       <div class="flex justify-center items-center gap-3 mt-2">
        <span id="seconds-v1" class="time-display text-2xl font-semibold text-blue-200 text-glow-blue">40</span>
        <span class="text-xl opacity-60 text-blue-300">|</span>
        <div class="text-xl font-medium">
         <span id="period-v1" class="text-blue-300">上午</span> 
         <span id="timezone-v1" class="font-bold text-blue-300 ml-2 subtle-pulse">本地时间</span> 
        </div>
       </div>
      </div>
      
      <div class="text-center mb-8">
       <div class="text-xl font-semibold mb-1 text-white text-glow-light">
        <span id="day-name-v1">星期六</span>
       </div>
       <div class="text-base opacity-90 text-blue-100">
        <span id="date-v1">2025年12月13日</span>
       </div>
      </div>
      
      <div class="text-center border-t border-white/10 pt-6">
        <a id="thatskynews-link-v1" href="https://cutt.ly/skynew" target="_blank" class="text-sm opacity-70 text-blue-200 hover:text-blue-100 hover:opacity-100 transition-all duration-300 inline-block">
          thatskynews
        </a>
        
        <div class="flex justify-between items-center mt-4">
          <div class="text-left">
            <div id="weather-status-v1" class="text-base font-medium text-white">下雪中</div>
            <div id="weather-timer-v1" class="text-xs opacity-80 text-blue-200"><span id="countdown-v1">60</span>秒</div>
          </div>
          
          <button id="config-btn-v1" class="border border-blue-400 hover:border-blue-300 text-blue-400 hover:text-blue-300 rounded-full w-10 h-10 flex items-center justify-center text-lg transition-all duration-300 hover:shadow-lg gentle-glow btn-spring-effect">
           <span id="v1-button-emoji">✨</span> 
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="layout-v2" class="hidden w-full h-full overflow-auto flex flex-col items-center pt-16 p-4">
    <div class="text-center mb-6 fade-in relative z-10">
       <p id="custom-title-cn-v2" class="text-3xl font-bold text-white title-glow">今天过得怎么样?</p>
       <p id="custom-title-en-v2" class="text-base text-white/70 font-light tracking-wider">How was your day?</p>
    </div>

    <div class="glass-card-v1 p-8 max-w-lg w-full fade-in relative z-10">
      
      <header class="flex justify-between w-full mb-6 items-start">
          <div class="text-left">
              <h2 id="title-v2" class="text-3xl font-extrabold glowing mb-1 text-white">Sky</h2>
              <p id="city-name-wrapper-v2" class="text-base text-white/80 font-medium">
                  <span id="country-name-v2">定位中</span> 
                  <span id="city-name-v2" class="text-white/80">城市</span>
              </p>
          </div>

          <button id="config-btn-v2" class="flex flex-col items-end text-right transition-transform hover:scale-105 btn-spring-effect">
              <div class="flex items-center gap-1">
                  <div id="weather-status-v2" class="text-base font-bold text-white/90">下雪中</div>
                  <div id="weather-timer-v2" class="text-sm font-semibold text-white/70">
                      <span id="countdown-v2">24</span>秒
                  </div>
              </div>
          </button>
      </header>
      
      <div class="text-center mb-6">
       <div class="time-display flex justify-center items-center gap-1 mb-6">
        <span id="hours-v2" class="text-8xl font-bold text-white glowing leading-none">04</span>
        <span class="colon-blink text-8xl font-bold text-white glowing relative -top-1 leading-none">:</span>
        <span id="minutes-v2" class="text-8xl font-bold text-white glowing leading-none">14</span>
       </div>
       
       <div class="flex justify-center items-center w-full max-w-md mx-auto">
        <span id="seconds-v2" class="time-display text-3xl font-semibold blue-glow-text w-12 text-right flex-shrink-0">
          40
        </span>
        
        <div class="h-6 w-px bg-white/20 mx-4 flex-shrink-0"></div>
        
        <div id="time-timezone-wrapper-v2" class="text-xl font-medium text-left flex-shrink-0">
         <span id="period-v2" class="text-white/90 mr-2">下午</span> 
         <span id="timezone-v2" class="font-medium text-white/90">本地时间</span> 
        </div>
       </div>
      </div>
      
      <div class="text-center mt-10">
       <div class="text-lg font-semibold mb-1 text-white">
        <span id="day-name-v2">星期六</span>
       </div>
       <div class="text-base opacity-90 text-white/70">
        <span id="date-v2">2025年12月13日</span>
       </div>
      </div>
    </div>
    
    <a id="thatskynews-link-v2" href="https://cutt.ly/skynew" target="_blank" class="text-sm text-white/50 mt-12 relative z-10 hover:text-white/80 transition-colors duration-300">
       thatskynews
     </a>
  </div>

  <div id="config-panel-unified" class="p-6 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 hidden z-50 max-w-md w-11/12 config-hidden">
     
     <h3 id="theme-settings-title" class="text-2xl font-bold mb-5 text-white flex items-center border-b border-white/20 pb-3 btn-spring-effect theme-title-center">
      <span class="mr-2 text-3xl"></span> 主题设置
     </h3>
     
     <div class="grid grid-cols-2 gap-4">
       <div class="config-item col-span-2">
        <label class="block text-sm font-medium mb-1 text-white/80">界面版式</label>
        <div class="flex gap-2">
          <button id="layout-option-1" class="flex-1 text-white py-3 config-button-base config-button-inactive btn-spring-effect">
            <div class="text-base font-medium">版式一</div>
            <div class="text-xs opacity-80 text-white/70">经典布局</div>
          </button>
          <button id="layout-option-2" class="flex-1 text-white py-3 config-button-base config-button-inactive btn-spring-effect">
            <div class="text-base font-medium">版式二</div>
            <div class="text-xs opacity-80 text-white/70">简约布局</div>
          </button>
        </div>
       </div>
       
       <div class="config-item">
        <label class="block text-sm font-medium mb-1 text-white/80">时区选择</label>
        <div id="timezone-select-display" class="custom-timezone-display w-full px-3 py-2 text-white flex justify-between items-center btn-spring-effect">
            <span id="current-timezone-name"></span>
            <span class="select-arrow">▼</span>
        </div>
       </div>
       
       <div class="config-item">
        <label class="block text-sm font-medium mb-1 text-white/80">时间格式</label>
        <div class="flex gap-2">
          <button id="format-12-unified" class="flex-1 text-white py-2 config-button-base config-button-inactive btn-spring-effect">12制</button>
          <button id="format-24-unified" class="flex-1 text-white py-2 config-button-base config-button-inactive btn-spring-effect">24制</button>
        </div>
       </div>

       <div class="config-item col-span-2">
         <div id="timezone-status-unified" class="timezone-status-display opacity-0 hidden">
           当前时区状态：<span id="status-text-unified"></span>
         </div>
       </div>
       
       <div class="config-item">
        <label class="block text-sm font-medium mb-1 text-white/80">天气效果</label>
        <div class="flex gap-2">
          <button id="weather-snow-unified" class="flex-1 text-white py-2 config-button-base config-button-inactive btn-spring-effect">雪景</button>
          <button id="weather-rain-unified" class="flex-1 text-white py-2 config-button-base config-button-inactive btn-spring-effect">雨景</button>
        </div>
       </div>
       
       <div class="config-item">
        <label class="block text-sm font-medium mb-1 text-white/80">效果速度: <span id="speed-value-unified">中</span></label>
        <input id="weather-speed-unified" type="range" min="1" max="10" value="5" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
       </div>
       
       <div class="col-span-2 mt-4">
        <button id="save-config-unified" class="w-full save-button-blue text-white font-bold py-3 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl btn-spring-effect">
          保存设置并关闭
        </button>
       </div>
     </div>
  </div>
  
  <div id="timezone-modal" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 hidden p-6 max-w-xs w-11/12" style="opacity: 0; transform: translate(-50%, -50%) scale(0.8);">
      <h4 class="text-xl font-bold text-white mb-4">选择时区</h4>
      <div id="timezone-options-container" class="space-y-3">
          <div class="timezone-option text-white py-3 px-4 text-center cursor-pointer" data-timezone="local">本地时间</div>
          <div class="timezone-option text-white py-3 px-4 text-center cursor-pointer" data-timezone="Asia/Shanghai">中国标准时间 (GMT+8)</div>
          <div class="timezone-option text-white py-3 px-4 text-center cursor-pointer" data-timezone="America/Los_Angeles">美国太平洋时间（PST/PDT）</div>
      </div>
      <button id="close-modal-btn" class="w-full mt-6 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition-colors btn-spring-effect">关闭</button>
  </div>
  
  <div id="dev-mode-modal" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 hidden p-6 max-w-xs w-11/12" style="opacity: 0; transform: translate(-50%, -50%) scale(0.8);">
      <h4 class="text-xl font-bold text-white mb-4 text-center">自定义开发者模式</h4>
      <div class="space-y-4">
          
          <label class="block text-sm font-medium mb-1 text-white/80">自定义标题</label>
          <input id="dev-input-cn" type="text" class="dev-input" placeholder="今天过得怎么样？">
          
          <label class="block text-sm font-medium mb-1 text-white/80">自定义副标题 </label>
          <input id="dev-input-en" type="text" class="dev-input" placeholder="How was your day?">
          
          <label class="block text-sm font-medium mb-1 text-white/80">自定义主标题 </label>
          <input id="dev-input-sky" type="text" class="dev-input" placeholder="Sky">
          
      </div>
      
      <button id="advanced-config-btn" class="w-full mt-6 py-3 save-button-blue text-white font-bold rounded-xl transition-all duration-300 btn-spring-effect">
        高级定义
      </button>

      <button id="save-dev-mode-btn" class="w-full mt-3 py-3 save-button-blue text-white font-bold rounded-xl transition-all duration-300 btn-spring-effect">
        保存并关闭
      </button>
      <button id="close-dev-mode-btn" class="w-full mt-3 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition-colors btn-spring-effect">
        重置默认效果
      </button>
  </div>

  <div id="advanced-config-modal" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 hidden p-6 max-w-xs w-11/12" style="opacity: 0; transform: translate(-50%, -50%) scale(0.8);">
      <h4 class="text-xl font-bold text-white mb-6 text-center">高级定义</h4>
      
      <div id="v1-style-config" class="border border-white/10 p-4 rounded-xl mb-6">
          <h5 class="text-lg font-semibold text-white mb-3 border-b border-white/10 pb-2">V1设置UI自定义</h5>
          
          <input id="v1-emoji-input" type="text" class="dev-input text-center text-xl" placeholder="✨">
          <p id="emoji-error-message" class="text-red-400 text-xs mt-1 hidden">请输入单个 Emoji 或图标。</p>
      </div>

      <div class="text-center space-y-4">
          <p class="text-lg font-medium text-white/90">待开发中....</p>
          <p class="text-sm text-blue-300">
             欢迎给我们发送您的建议
             <a href="mailto:goskynews@outlook.com" class="text-blue-200 hover:text-blue-100 font-semibold underline transition-colors">
                 goskynews@outlook.com
             </a>
          </p>
      </div>
      
      <button id="save-advanced-config-btn" class="w-full mt-6 py-3 save-button-blue text-white font-bold rounded-xl transition-all duration-300 btn-spring-effect">
        保存并返回
      </button>

      <button id="close-advanced-config-btn" class="w-full mt-3 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition-colors btn-spring-effect">关闭</button>
  </div>


  <script>
    // --------------------------------- JavaScript 核心逻辑 ---------------------------------
    
    // 配置状态
    const config = {
      // 保持用户最初设置的默认值
      timezone: 'America/Los_Angeles', 
      timeFormat: '24',
      weatherSpeed: 5,
      layout: 'v2', 
      weatherType: 'snow',
      // !!! 核心新增：自定义开发者模式的配置项
      customTitleCN: '今天过得怎么样？',
      customTitleEN: 'How was your day?',
      customTitleSky: 'Sky',
      // !!! 核心新增：V1 版式按钮 Emoji
      v1ButtonEmoji: '✨' 
    };
    
    // 时区信息映射
    const timezoneInfo = {
      // 在定位成功前，使用这些初始值
      'local': { name: '本地时间', country: '定位中', city: '城市' }, 
      'Asia/Shanghai': { name: '中国标准时间', city: '北京', country: '中国' },
      'America/Los_Angeles': { name: '太平洋标准时间', city: '洛杉矶', country: '美国' }
    };
    
    // 配置面板显示文本映射
    const timezoneDisplayNames = {
        'local': '本地时间',
        'Asia/Shanghai': '中国标准时间 (GMT+8)',
        'America/Los_Angeles': '美国太平洋时间（PST/PDT）'
    };
    
    /**
     * 新增：中文字典，用于翻译 ipinfo.io 返回的常见英文/拼音地名
     */
    const chineseTranslationMap = {
        // 常见省份
        'Beijing': '北京',
        'Shanghai': '上海',
        'Guangdong': '广东',
        'Jiangsu': '江苏',
        'Zhejiang': '浙江',
        'Sichuan': '四川',
        'Hubei': '湖北',
        'Hunan': '湖南',
        'Fujian': '福建',
        'Shandong': '山东',
        'Liaoning': '辽宁',
        'Heilongjiang': '黑龙江',
        'Jilin': '吉林',
        'Gansu': '甘肃',
        'Shaanxi': '陕西',
        'Hebei': '河北',
        'Henan': '河南',
        'Anhui': '安徽',
        'Jiangxi': '江西',
        'Chongqing': '重庆',
        'Tianjin': '天津',
        // 常见城市
        'Shenzhen': '深圳',
        'Guangzhou': '广州',
        'Chengdu': '成都',
        'Hangzhou': '杭州',
        'Wuhan': '武汉',
        'Nanjing': '南京',
        'Suzhou': '苏州',
        'Los Angeles': '洛杉矶',
        // 国家
        'United States': '美国',
        'US': '美国',
        'CN': '中国'
    };
    
    /**
     * 辅助函数：将英文/拼音翻译成中文
     */
    function translateToChinese(text) {
        if (!text) return '';
        // 尝试匹配原始文本
        if (chineseTranslationMap[text]) {
            return chineseTranslationMap[text];
        }
        // 尝试匹配首字母大写的文本
        const capitalizedText = text.charAt(0).toUpperCase() + text.slice(1);
        if (chineseTranslationMap[capitalizedText]) {
            return chineseTranslationMap[capitalizedText];
        }
        // 都没有，返回原始文本
        return text;
    }


    /**
     * 新增：通过 IP 地址获取用户的粗略地理位置 (省和市)，并进行中文翻译
     */
    async function fetchLocalGeographicInfo() {
        const defaultCountry = '本地';
        const defaultCity = '城市';
        
        try {
            // 使用公共 IP 定位服务
            const response = await fetch('https://ipinfo.io/json');
            
            if (!response.ok) {
                console.warn('IP定位服务返回失败，使用默认值。');
                return;
            }
            
            const data = await response.json();
            
            let resolvedCountry = data.country || ''; 
            let resolvedCity = data.city || ''; 
            let resolvedRegion = data.region || ''; 
            
            // 核心逻辑：进行中文翻译和格式化
            
            const translatedCountry = translateToChinese(resolvedCountry);
            const translatedRegion = translateToChinese(resolvedRegion);
            const translatedCity = translateToChinese(resolvedCity);


            // 优化显示逻辑：
            if (data.country === 'CN' && resolvedRegion && resolvedCity) {
                // 中国地区：显示 省份(Region) + 城市(City)
                timezoneInfo['local'].country = translatedRegion; // country字段用于显示省份
                timezoneInfo['local'].city = translatedCity; 
            } else if (translatedCountry && translatedCity) {
                // 国际地区：显示 国家(Country) + 城市(City)
                timezoneInfo['local'].country = translatedCountry; 
                timezoneInfo['local'].city = translatedCity;
            } else {
                 // 默认值
                 timezoneInfo['local'].country = defaultCountry;
                 timezoneInfo['local'].city = defaultCity;
            }
            
            console.log(`[IP定位成功] 地区: ${timezoneInfo['local'].country} ${timezoneInfo['local'].city}`);
            
            // 如果用户当前选择的是“本地时间”，则立即更新显示
            if (config.timezone === 'local') {
                updateTime();
            }

        } catch (error) {
            console.error('IP定位请求失败:', error);
            timezoneInfo['local'].country = defaultCountry;
            timezoneInfo['local'].city = defaultCity;
        }
    }


    // 太平洋时间夏令时/冬令时判断函数
    function isPacificDST(date) {
        const year = date.getFullYear();
        // 查找3月第二个周日
        let march = new Date(year, 2, 1);
        while (march.getDay() !== 0) march.setDate(march.getDate() + 1); // 找到第一个周日
        march.setDate(march.getDate() + 7); // 找到第二个周日 (DST开始日)

        // 查找11月第一个周日
        let november = new Date(year, 10, 1);
        while (november.getDay() !== 0) november.setDate(november.getDate() + 1); // 找到第一个周日 (DST结束日)

        if (date >= march && date < november) {
            return true; // 夏令时 (PDT)
        }
        return false; // 冬令时 (PST)
    }

    // 更新时区状态显示
    function updateTimezoneStatus(selectedTimezone) {
        const statusContainer = document.getElementById('timezone-status-unified');
        const statusTextEl = document.getElementById('status-text-unified');
        
        if (selectedTimezone === 'America/Los_Angeles') {
            const nowInLA = new Date(new Date().toLocaleString('en-US', { timeZone: selectedTimezone }));
            const isDST = isPacificDST(nowInLA);
            
            const status = isDST ? '夏令时 (PDT)' : '冬令时 (PST)';
            
            statusTextEl.textContent = status;
            statusContainer.classList.remove('hidden', 'opacity-0');
            statusContainer.classList.add('opacity-100'); // 显示状态
        } else {
            // 隐藏状态
            statusContainer.classList.remove('opacity-100');
            statusContainer.classList.add('opacity-0');
            setTimeout(() => {
                statusContainer.classList.add('hidden');
            }, 300); // 等待过渡动画完成
        }
    }


    // 天气状态变量
    let isSnowing = true;
    let particles = [];
    let weatherInterval;
    let countdown = 60;
    let updateInterval;
    
    // !!! 核心新增：双击计时器
    let clickCount = 0;
    let clickTimer = null;


    // 按钮样式常量
    const CLASS_ACTIVE = 'config-button-active';
    const CLASS_INACTIVE = 'config-button-inactive';

    // --------------------------------- 配置与UI同步 ---------------------------------

    function saveConfig() {
      localStorage.setItem('timeDisplayConfig', JSON.stringify(config));
    }

    function loadConfig() {
      const saved = localStorage.getItem('timeDisplayConfig');
      if (saved) {
        Object.assign(config, JSON.parse(saved));
        // 同步 isSnowing 状态
        isSnowing = config.weatherType === 'snow';
      }
    }

    // 根据配置更新配置面板按钮和值
    function syncConfigPanel() {
      // 统一按钮更新函数
      const updateButton = (id, isActive) => {
        const btn = document.getElementById(id);
        if (btn) {
          // 确保基础类和回弹类存在
          btn.className = `flex-1 text-white py-2 config-button-base btn-spring-effect ${isActive ? CLASS_ACTIVE : CLASS_INACTIVE}`;
          // 特殊处理版式按钮，它们有额外的子元素和不同的 padding
          if (id.includes('layout')) {
             btn.className = `flex-1 text-white py-3 config-button-base btn-spring-effect ${isActive ? CLASS_ACTIVE : CLASS_INACTIVE}`;
          }
        }
      };

      // 时间格式
      updateButton('format-12-unified', config.timeFormat === '12');
      updateButton('format-24-unified', config.timeFormat === '24');
      
      // 天气效果
      updateButton('weather-snow-unified', config.weatherType === 'snow');
      updateButton('weather-rain-unified', config.weatherType === 'rain');
      
      // 版式选择
      updateButton('layout-option-1', config.layout === 'v1');
      updateButton('layout-option-2', config.layout === 'v2');
      
      // 核心修改：时区：更新自定义显示 div 的文本 (已应用省略号 CSS)
      document.getElementById('current-timezone-name').textContent = timezoneDisplayNames[config.timezone] || config.timezone;
      
      // 核心修改：时区：更新模态选项的 active 状态
      document.querySelectorAll('#timezone-modal .timezone-option').forEach(option => {
          if (option.getAttribute('data-timezone') === config.timezone) {
              option.classList.add('active-option');
          } else {
              option.classList.remove('active-option');
          }
      });
      
      const speedSlider = document.getElementById('weather-speed-unified');
      if (speedSlider) {
        speedSlider.value = config.weatherSpeed;
        document.getElementById('speed-value-unified').textContent = 
          config.weatherSpeed <= 3 ? '慢' : config.weatherSpeed <= 7 ? '中' : '快';
      }
      
      // 更新时区状态显示
      updateTimezoneStatus(config.timezone);
    }
    
    // !!! 核心新增：同步开发者模式面板的输入框值
    function syncDevModePanel() {
        document.getElementById('dev-input-cn').value = config.customTitleCN;
        document.getElementById('dev-input-en').value = config.customTitleEN;
        document.getElementById('dev-input-sky').value = config.customTitleSky;
    }
    
    // !!! 核心新增：同步高级配置面板的输入框值
    function syncAdvancedConfigPanel() {
        document.getElementById('v1-emoji-input').value = config.v1ButtonEmoji;
        document.getElementById('emoji-error-message').classList.add('hidden'); // 默认隐藏错误信息
    }


    // --------------------------------- 交互功能 ---------------------------------

    // 控制配置面板的显示/隐藏 (定稿丝滑回弹动效)
    function toggleConfigPanel(show) {
        const panel = document.getElementById('config-panel-unified');
        const overlay = document.getElementById('overlay');
        
        if (show) {
            syncConfigPanel(); // 每次打开时更新面板状态
            panel.classList.remove('hidden');
            overlay.classList.remove('hidden');
            
            // 应用回弹 CSS 类
            panel.classList.remove('config-hidden');
            panel.classList.add('config-active');

            // 确保粒子在面板上层可见
            document.getElementById('weather-container').style.zIndex = '45'; 
            setTimeout(() => {
                overlay.classList.add('active');
            }, 10);
        } else {
            // 移除回弹 CSS 类，触发关闭动画
            panel.classList.remove('config-active');
            panel.classList.add('config-hidden');
            
            overlay.classList.remove('active');
            document.getElementById('weather-container').style.zIndex = '0'; // 恢复粒子层级
            
            // 核心修改：延迟隐藏 panel 和 overlay，等待 CSS transition 时间 (0.6s/0.4s) 完成
            setTimeout(() => {
                panel.classList.add('hidden');
                overlay.classList.add('hidden');
                // 确保模态框在关闭主面板时也关闭
                if (document.getElementById('timezone-modal').style.opacity !== '0') {
                    toggleTimezoneModal(false);
                }
                // !!! 核心新增：确保开发者模式弹窗在关闭主面板时也关闭
                if (document.getElementById('dev-mode-modal').style.opacity !== '0') {
                    toggleDevModeModal(false);
                }
                // !!! 核心新增：确保高级配置弹窗在关闭主面板时也关闭
                if (document.getElementById('advanced-config-modal').style.opacity !== '0') {
                    toggleAdvancedConfigModal(false);
                }
            }, 600); // 匹配 transform 0.6s
        }
    }
    
    // 控制自定义时区选择模态弹窗的显示/隐藏 (带动画) - 沿用此函数结构用于新的弹窗
    function toggleTimezoneModal(show) {
        const modal = document.getElementById('timezone-modal');
        const modalOverlay = document.getElementById('modal-overlay');

        if (show) {
            // 确保主配置面板可见，但层级在模态背景之下
            if (document.getElementById('config-panel-unified').classList.contains('hidden')) {
                toggleConfigPanel(true); // 如果配置面板没开，先开
            }
            
            modal.classList.remove('hidden');
            modalOverlay.classList.remove('hidden');
            
            // 触发动画
            setTimeout(() => {
                modalOverlay.classList.add('active'); // 使用 active 类控制 opacity 和 pointer-events
                modal.style.transform = 'translate(-50%, -50%) scale(1)';
                modal.style.opacity = '1';
                modal.style.zIndex = '60'; // 确保在配置面板之上
            }, 10);
        } else {
            // 触发反向动画
            modalOverlay.classList.remove('active');
            modal.style.transform = 'translate(-50%, -50%) scale(0.8)';
            modal.style.opacity = '0';

            // 延迟隐藏 DOM
            setTimeout(() => {
                modal.classList.add('hidden');
                modalOverlay.classList.add('hidden');
            }, 300);
        }
    }
    
    // !!! 核心修改：控制自定义开发者模式模态弹窗的显示/隐藏 
    function toggleDevModeModal(show) {
        const modal = document.getElementById('dev-mode-modal');
        const modalOverlay = document.getElementById('modal-overlay'); // 共用 overlay

        if (show) {
            syncDevModePanel(); // 打开前同步当前值
            
            // 确保主配置面板可见
            if (document.getElementById('config-panel-unified').classList.contains('hidden')) {
                toggleConfigPanel(true);
            }
            
            modal.classList.remove('hidden');
            // 仅在打开时激活遮罩层，但如果高级配置打开，则不处理
            if (document.getElementById('advanced-config-modal').style.opacity !== '1') {
                modalOverlay.classList.remove('hidden');
                modalOverlay.classList.add('active');
            }
            
            // 触发动画
            setTimeout(() => {
                modal.style.transform = 'translate(-50%, -50%) scale(1)';
                modal.style.opacity = '1';
                modal.style.zIndex = '60'; // 默认层级
            }, 10);
        } else {
            // 触发反向动画
            // 仅在没有其他模态框打开时才关闭遮罩层
             if (document.getElementById('advanced-config-modal').style.opacity !== '1' && document.getElementById('timezone-modal').style.opacity !== '1') {
                modalOverlay.classList.remove('active');
                setTimeout(() => {
                    modalOverlay.classList.add('hidden');
                }, 300);
            }
            
            modal.style.transform = 'translate(-50%, -50%) scale(0.8)';
            modal.style.opacity = '0';

            // 延迟隐藏 DOM
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
    }
    
    // !!! 核心修复：控制高级配置模态弹窗的显示/隐藏 (现在它来处理遮罩层堆叠)
    function toggleAdvancedConfigModal(show) {
        const modal = document.getElementById('advanced-config-modal');
        const modalOverlay = document.getElementById('modal-overlay');
        const devModal = document.getElementById('dev-mode-modal'); 
        const configPanel = document.getElementById('config-panel-unified'); // 主配置面板

        if (show) {
             // 确保主配置面板可见
            if (configPanel.classList.contains('hidden')) {
                toggleConfigPanel(true);
            }
            
            syncAdvancedConfigPanel(); // 打开前同步当前值
            
            modal.classList.remove('hidden');
            
            // 核心修复：将主配置面板的 Z-index 降级到遮罩层之下
            configPanel.style.zIndex = '30'; // 原 Z-index 50

            // !!! 核心修复：将开发者模式弹窗的 Z-index 降级到遮罩层 (Z=55) 之下，以实现模糊效果
            if (devModal) {
                 devModal.style.zIndex = '50'; 
                 devModal.style.opacity = '0.5'; // 额外的视觉提示：调低透明度
            }
            
            // 显示遮罩层
            modalOverlay.classList.remove('hidden');
            
            // 触发动画
            setTimeout(() => {
                modalOverlay.classList.add('active'); // 激活遮罩层
                modal.style.transform = 'translate(-50%, -50%) scale(1)';
                modal.style.opacity = '1';
                modal.style.zIndex = '70'; // 确保在开发者模式之上 (dev-mode z-index now 50)
            }, 10);
        } else {
            // 触发反向动画
            modal.style.transform = 'translate(-50%, -50%) scale(0.8)';
            modal.style.opacity = '0';
            
            // 核心修复：关闭时，恢复主配置面板的 Z-index
            configPanel.style.zIndex = '50'; // 恢复主配置面板 Z-index

            // !!! 核心修复：恢复开发者模式弹窗的 Z-index 和透明度
            if (devModal) {
                 devModal.style.zIndex = '60'; // 恢复开发者模式的 z-index
                 devModal.style.opacity = '1'; // 恢复透明度
            }
            
            // 仅在没有其他模态框打开时才关闭遮罩层
            if (document.getElementById('dev-mode-modal').style.opacity !== '1' && document.getElementById('timezone-modal').style.opacity !== '1') {
                 modalOverlay.classList.remove('active');
            }
            
            // 延迟隐藏 DOM
            setTimeout(() => {
                modal.classList.add('hidden');
                // 仅在没有其他模态框打开时才隐藏 DOM
                if (document.getElementById('dev-mode-modal').style.opacity !== '1' && document.getElementById('timezone-modal').style.opacity !== '1') {
                    modalOverlay.classList.add('hidden');
                }
            }, 300);
        }
    }
    
    // !!! 核心新增：保存高级配置
    function saveAdvancedConfig() {
        const emojiInput = document.getElementById('v1-emoji-input');
        const errorMessage = document.getElementById('emoji-error-message');
        const newEmoji = emojiInput.value.trim();
        
        // 核心修复：使用 Array.from() 来准确计算 Unicode 字符数（包括复杂 Emoji 组合）
        if (newEmoji.length > 0 && Array.from(newEmoji).length === 1) {
            config.v1ButtonEmoji = newEmoji;
            errorMessage.classList.add('hidden');
            saveConfig();
            updateTime(); // 立即应用到 V1 布局
            toggleAdvancedConfigModal(false); // 保存后关闭
        } else if (newEmoji.length === 0) {
            // 如果为空，则恢复默认
            config.v1ButtonEmoji = '✨';
            errorMessage.classList.add('hidden');
            saveConfig();
            updateTime();
            toggleAdvancedConfigModal(false);
        } else {
            // 验证失败
            errorMessage.textContent = `在定界框输入了 ${Array.from(newEmoji).length} 个单位，只允许1个单位。`;
            errorMessage.classList.remove('hidden');
            emojiInput.focus(); // 聚焦到输入框
        }
    }


    // 切换版式
    function switchLayout(layoutType) {
      config.layout = layoutType;
      
      document.getElementById('layout-v1').classList.toggle('hidden', layoutType !== 'v1');
      document.getElementById('layout-v2').classList.toggle('hidden', layoutType !== 'v2');
      
      // 更新配置面板的版式按钮状态
      syncConfigPanel(); 
    }

    // 设置天气效果 (用于手动配置)
    function setWeather(type) {
      isSnowing = type === 'snow';
      config.weatherType = type;
      
      // 更新两个版式的天气状态显示
      const statusText = isSnowing ? '下雪中' : '下雨中';
      document.getElementById('weather-status-v1').textContent = statusText;
      document.getElementById('weather-status-v2').textContent = statusText;
      
      // 重新创建粒子效果
      createWeatherParticles(); 
      syncConfigPanel();
    }

    // 创建天气粒子 (统一函数)
    function createWeatherParticles() {
      const container = document.getElementById('weather-container');
      const particleCount = isSnowing ? 60 : 80;
      const speedFactor = 6 / config.weatherSpeed;
      
      // 清除现有粒子
      container.innerHTML = '';
      particles = [];
      
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        const size = isSnowing ? Math.random() * 4 + 2 : Math.random() * 3 + 1;
        
        if (isSnowing) {
          particle.className = 'weather-particle snowflake';
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;
        } else {
          particle.className = 'weather-particle raindrop';
          particle.style.width = `${size}px`;
          particle.style.height = `${size * 1.5}px`;
        }
        
        const startX = Math.random() * 100;
        const delay = Math.random() * 5;
        const duration = (Math.random() * 3 + 3) * speedFactor;
        
        particle.style.left = `${startX}vw`;
        particle.style.top = '-20px';
        particle.style.animation = `${isSnowing ? 'snowFall' : 'rainFall'} ${duration}s linear ${delay}s infinite`;
        
        container.appendChild(particle);
        particles.push({ element: particle });
      }
    }

    // 自动切换天气
    function toggleWeather() {
      isSnowing = !isSnowing;
      config.weatherType = isSnowing ? 'snow' : 'rain';
      
      setWeather(config.weatherType); // 使用 setWeather 自动更新UI和粒子
      
      countdown = 60;
      updateCountdown();
    }
    
    // 更新倒计时显示
    function updateCountdown() {
      const countdownEl1 = document.getElementById('countdown-v1');
      const countdownEl2 = document.getElementById('countdown-v2');
      if (countdownEl1) countdownEl1.textContent = countdown;
      if (countdownEl2) countdownEl2.textContent = countdown;
    }

    // 开始天气切换计时器
    function startWeatherTimer() {
      if (weatherInterval) clearInterval(weatherInterval);
      
      weatherInterval = setInterval(() => {
        countdown--;
        updateCountdown();
        
        if (countdown <= 0) {
          toggleWeather();
        }
      }, 1000);
    }

    // 更新时间显示 (包含自定义标题的更新)
    function updateTime() {
      let displayTime;
      
      if (config.timezone === 'local') {
        displayTime = new Date();
      } else {
        // 使用 toLocaleString 和 timeZone 获取指定时区的时间
        const timeStr = new Date().toLocaleString('en-US', { timeZone: config.timezone });
        displayTime = new Date(timeStr);
        if (displayTime.toString() === 'Invalid Date') displayTime = new Date();
      }
      
      let hours = displayTime.getHours();
      const minutes = displayTime.getMinutes();
      const seconds = displayTime.getSeconds();
      
      const period = hours >= 12 ? '下午' : '上午'; // 统一计算上午/下午

      let displayHours = hours;
      
      // 只有在 12 小时制时才转换 hours
      if (config.timeFormat === '12') {
        displayHours = hours % 12;
        displayHours = displayHours ? displayHours : 12; // 12点处理
      } else {
        // 24小时制保持 0-23
      }
      
      const hoursStr = String(displayHours).padStart(2, '0');
      const minutesStr = String(minutes).padStart(2, '0');
      const secondsStr = String(seconds).padStart(2, '0');
      
      const tzInfo = timezoneInfo[config.timezone] || timezoneInfo['local']; // 确保 fallback
      
      const dayNames = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
      // 修正中文月份显示（用数字和“月”）
      const dayName = dayNames[displayTime.getDay()];
      const monthIndex = displayTime.getMonth();
      const date = displayTime.getDate();
      const year = displayTime.getFullYear();
      const formattedDate = `${year}年${monthIndex + 1}月${date}日`;

      
      // V1 更新
      document.getElementById('hours-v1').textContent = hoursStr;
      document.getElementById('minutes-v1').textContent = minutesStr;
      document.getElementById('seconds-v1').textContent = secondsStr;
      document.getElementById('period-v1').textContent = period; 
      document.getElementById('timezone-v1').textContent = tzInfo.name;
      document.getElementById('city-name-v1').textContent = tzInfo.country + ' ' + tzInfo.city;
      document.getElementById('day-name-v1').textContent = dayName;
      document.getElementById('date-v1').textContent = formattedDate;
      // !!! 核心新增：自定义标题 V1
      document.getElementById('custom-title-cn-v1').textContent = config.customTitleCN;
      document.getElementById('custom-title-en-v1').textContent = config.customTitleEN;
      document.getElementById('title-v1').textContent = config.customTitleSky; // "Sky"
      // !!! 核心新增：V1 按钮 Emoji
      document.getElementById('v1-button-emoji').textContent = config.v1ButtonEmoji; 

      // V2 更新
      document.getElementById('hours-v2').textContent = hoursStr;
      document.getElementById('minutes-v2').textContent = minutesStr;
      document.getElementById('seconds-v2').textContent = secondsStr;
      document.getElementById('period-v2').textContent = period;
      document.getElementById('timezone-v2').textContent = tzInfo.name;
      document.getElementById('country-name-v2').textContent = tzInfo.country;
      document.getElementById('city-name-v2').textContent = tzInfo.city;
      document.getElementById('day-name-v2').textContent = dayName;
      document.getElementById('date-v2').textContent = formattedDate;
      // !!! 核心新增：自定义标题 V2
      document.getElementById('custom-title-cn-v2').textContent = config.customTitleCN;
      document.getElementById('custom-title-en-v2').textContent = config.customTitleEN;
      document.getElementById('title-v2').textContent = config.customTitleSky; // "Sky"
      
      // 每次更新时间时，检查太平洋时间状态
      updateTimezoneStatus(config.timezone);
    }

    // 应用配置
    function applyConfig() {
      switchLayout(config.layout);
      updateTime();
      setWeather(config.weatherType); // 包含 createWeatherParticles()
      syncConfigPanel();
    }

    // --------------------------------- 初始化 ---------------------------------

    function initialize() {
      loadConfig();
      
      // *** 核心新增：加载时获取本地地理信息，并进行中文翻译 ***
      fetchLocalGeographicInfo(); 
      
      // 1. 统一事件监听器
      
      // 配置按钮 - 打开面板 (V1 和 V2)
      document.getElementById('config-btn-v1').addEventListener('click', () => toggleConfigPanel(true));
      document.getElementById('config-btn-v2').addEventListener('click', () => toggleConfigPanel(true));
      
      // 遮罩层 - 点击空白处关闭面板
      document.getElementById('overlay').addEventListener('click', () => toggleConfigPanel(false));
      
      // 核心修改：时区选择器交互
      document.getElementById('timezone-select-display').addEventListener('click', () => toggleTimezoneModal(true));
      document.getElementById('close-modal-btn').addEventListener('click', () => toggleTimezoneModal(false));
      
      // !!! 核心修改：高级定义按钮交互 (不关闭开发者模式，直接打开高级配置)
      document.getElementById('advanced-config-btn').addEventListener('click', (e) => {
          e.stopPropagation(); // 阻止事件冒泡
          toggleAdvancedConfigModal(true); // 直接打开高级配置
      });
      
      // !!! 核心新增：保存高级配置
      document.getElementById('save-advanced-config-btn').addEventListener('click', saveAdvancedConfig);
      
      // !!! 核心新增：关闭高级配置 (返回到开发者模式弹窗)
      document.getElementById('close-advanced-config-btn').addEventListener('click', () => {
          toggleAdvancedConfigModal(false); // 关闭高级配置，但保留开发者模式
      });
      

      // 模态背景点击关闭逻辑 (已统一)
      document.getElementById('modal-overlay').addEventListener('click', (e) => {
          // 优先关闭最上层的弹窗
          if(e.target === document.getElementById('modal-overlay') && document.getElementById('advanced-config-modal').style.opacity === '1') {
            toggleAdvancedConfigModal(false); 
          } 
          // 如果高级配置弹窗没开，检查开发者模式
          else if(e.target === document.getElementById('modal-overlay') && document.getElementById('dev-mode-modal').style.opacity === '1') {
             toggleDevModeModal(false);
          }
          // 如果开发者模式也没开，检查时区选择
          else if(e.target === document.getElementById('modal-overlay') && document.getElementById('timezone-modal').style.opacity === '1') {
            toggleTimezoneModal(false);
          }
      });
      document.getElementById('timezone-modal').addEventListener('click', (e) => e.stopPropagation()); // 阻止冒泡到背景
      document.getElementById('dev-mode-modal').addEventListener('click', (e) => e.stopPropagation()); // 阻止冒泡到背景
      document.getElementById('advanced-config-modal').addEventListener('click', (e) => e.stopPropagation()); // 阻止冒泡到背景


      // 核心修改：时区选项点击处理
      document.querySelectorAll('#timezone-modal .timezone-option').forEach(option => {
          option.addEventListener('click', function() {
              const newTimezone = this.getAttribute('data-timezone');
              config.timezone = newTimezone;
              updateTime();
              syncConfigPanel();
              toggleTimezoneModal(false); // 选中后关闭模态框
          });
      });
      
      // 时间格式
      document.getElementById('format-12-unified').addEventListener('click', () => {
        config.timeFormat = '12';
        updateTime();
        syncConfigPanel();
      });
      
      document.getElementById('format-24-unified').addEventListener('click', () => {
        config.timeFormat = '24';
        updateTime();
        syncConfigPanel();
      });
      
      // 版式切换
      document.getElementById('layout-option-1').addEventListener('click', () => switchLayout('v1'));
      document.getElementById('layout-option-2').addEventListener('click', () => switchLayout('v2'));
      
      // 天气效果
      document.getElementById('weather-snow-unified').addEventListener('click', () => setWeather('snow'));
      document.getElementById('weather-rain-unified').addEventListener('click', () => setWeather('rain'));
      
      // 天气速度
      document.getElementById('weather-speed-unified').addEventListener('input', (e) => {
        config.weatherSpeed = parseInt(e.target.value);
        createWeatherParticles();
        syncConfigPanel();
      });
      
      // 保存设置
      document.getElementById('save-config-unified').addEventListener('click', () => {
        saveConfig();
        toggleConfigPanel(false); // 保存后关闭面板
      });
      
      // !!! 核心新增：主题设置主标题双击三次打开开发者模式
      const themeTitleEl = document.getElementById('theme-settings-title');
      themeTitleEl.addEventListener('click', () => {
          clickCount++;
          // 点击时加入回弹效果
          themeTitleEl.classList.add('btn-spring-effect');
          themeTitleEl.style.transform = 'scale(0.95)';
          setTimeout(() => {
              themeTitleEl.style.transform = 'scale(1)';
          }, 150);


          if (clickTimer) {
              clearTimeout(clickTimer);
          }

          clickTimer = setTimeout(() => {
              clickCount = 0; // 重置计数器
          }, 400); // 400ms 内视为连续点击

          if (clickCount === 3) {
              clickCount = 0; // 满足条件，重置计数
              clearTimeout(clickTimer);
              toggleDevModeModal(true); // 打开开发者模式
          }
      });
      
      // !!! 核心新增：开发者模式保存按钮
      document.getElementById('save-dev-mode-btn').addEventListener('click', () => {
          // 更新配置
          config.customTitleCN = document.getElementById('dev-input-cn').value.trim() || '今天过得怎么样？';
          config.customTitleEN = document.getElementById('dev-input-en').value.trim() || 'How was your day?';
          config.customTitleSky = document.getElementById('dev-input-sky').value.trim() || 'Sky';
          
          saveConfig();
          updateTime(); // 立即应用到界面
          toggleDevModeModal(false);
      });
      
      // !!! 核心新增：开发者模式重置按钮
      document.getElementById('close-dev-mode-btn').addEventListener('click', () => {
          // --- 核心修复逻辑开始 ---
          
          // 1. 重置配置状态到初始默认值
          config.customTitleCN = '今天过得怎么样？';
          config.customTitleEN = 'How was your day?';
          config.customTitleSky = 'Sky';
          config.v1ButtonEmoji = '✨'; // 也重置 V1 按钮 Emoji
          
          // 2. 保存重置后的配置
          saveConfig();
          
          // 3. 立即更新界面显示，将标题恢复为默认
          updateTime(); 
          
          // 4. 同步面板输入框的值，显示已重置
          syncDevModePanel(); 
          
          // 5. 关闭开发者模式弹窗
          toggleDevModeModal(false); 
          
          // --- 核心修复逻辑结束 ---
      });
      
      
      // 2. 应用初始配置
      applyConfig();
      
      // 3. 开始计时器
      if (updateInterval) clearInterval(updateInterval);
      updateInterval = setInterval(updateTime, 1000);
      
      // 4. 开始天气切换计时器
      startWeatherTimer();
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', initialize);
    
    // 窗口大小变化时重新创建粒子
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(createWeatherParticles, 200);
    });
  </script>
 </body>
</html>
